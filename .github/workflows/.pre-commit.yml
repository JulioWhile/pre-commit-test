name: Pre-Commit Quality Gate
on:
  pull_request:
  push:
    branches: [main, develop]

jobs:
  pre-commit-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Get changed files (for PR)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }} --deepen=100
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          grep -E '\.(py|yml|yaml|json|csv)$' changed_files.txt > filtered_files.txt || true

      - name: Get changed files (for push to main/develop)
        if: github.event_name == 'push'
        run: |
          git diff --name-only HEAD~1 HEAD > changed_files.txt
          grep -E '\.(py|yml|yaml|json|csv)$' changed_files.txt > filtered_files.txt || true

      - name: Run pre-commit checks
        run: |
          if [ -s filtered_files.txt ]; then
            echo "🔍 Running pre-commit checks..."
            echo "Files to check:"
            cat filtered_files.txt
            echo ""
            
            if xargs pre-commit run --files < filtered_files.txt; then
              echo "✅ All pre-commit checks passed!"
            else
              echo ""
              echo "❌ Pre-commit checks failed!"
              echo ""
              echo "To fix these issues locally:"
              echo "1. Install pre-commit: pip install pre-commit"
              echo "2. Install hooks: pre-commit install"
              echo "3. Run on your changed files only:"
              if [ "${{ github.event_name }}" == "pull_request" ]; then
                echo "   pre-commit run --files \$(git diff --name-only origin/${{ github.base_ref }}...HEAD)"
              else
                echo "   pre-commit run --files \$(git diff --name-only HEAD~1 HEAD)"
              fi
              echo "4. Commit and push the fixes"
              echo ""
              echo "Most issues can be auto-fixed. Commit the changes and push again."
              exit 1
            fi
          else
            echo "ℹ️  No relevant files to check."
          fi
