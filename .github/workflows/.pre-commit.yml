name: Pre-Commit Quality Gate
on:
  pull_request:
  push:
    branches: [main, develop]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important for getting full git history

      - name: Install UV
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python with UV
        run: |
          uv python install 3.11
          uv python pin 3.11

      - name: Install dependencies
        run: |
          uv sync --frozen
          uv pip install pre-commit

      - name: Get changed files (for PR)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          grep -E '\.(py|yml|yaml|json|csv)$' changed_files.txt > filtered_files.txt || true

      - name: Get changed files (for push)
        if: github.event_name == 'push'
        run: |
          git diff --name-only HEAD~1 HEAD > changed_files.txt
          grep -E '\.(py|yml|yaml|json|csv)$' changed_files.txt > filtered_files.txt || true

      - name: Debug - Show files to check
        run: |
          echo "Changed files:"
          cat changed_files.txt || echo "No changed_files.txt"
          echo ""
          echo "Filtered files for pre-commit:"
          cat filtered_files.txt || echo "No filtered_files.txt"

      - name: Run pre-commit checks
        run: |
          if [ -s filtered_files.txt ]; then
            echo "üîç Running pre-commit checks on changed files..."

            # Force pre-commit to run without cache to avoid "skipped" issues
            export PRE_COMMIT_NO_CACHE=1

            # Run with verbose output to see what's happening
            if uv run pre-commit run --verbose --files < filtered_files.txt; then
              echo "‚úÖ All pre-commit checks passed!"
            else
              echo ""
              echo "‚ùå Pre-commit checks failed!"
              echo ""
              echo "To fix locally, run:"
              if [ "${{ github.event_name }}" == "pull_request" ]; then
                echo "  uv run pre-commit run --files \$(git diff --name-only origin/${{ github.base_ref }}...HEAD)"
              else
                echo "  uv run pre-commit run --files \$(git diff --name-only HEAD~1 HEAD)"
              fi
              exit 1
            fi
          else
            echo "‚ÑπÔ∏è  No relevant files to check."
          fi
