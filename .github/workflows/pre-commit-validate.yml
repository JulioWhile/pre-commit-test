name: Pre-Commit Validation
on:
  workflow_run:
    workflows: ["Pre-Commit Auto-fix"]
    types: [completed]
  pull_request:
    types: [opened, synchronize]

jobs:
  validate:
    runs-on: ubuntu-latest
    # Only run validation if:
    # 1. The auto-fix workflow completed successfully, OR
    # 2. This is a direct PR event (for initial validation)
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'pull_request')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For workflow_run events, we need to checkout the PR branch
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.head_ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Install pre-commit
        run: pip install pre-commit
      
      - name: Get base branch for comparison
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            # For workflow_run, we need to get the base branch from the original PR
            echo "BASE_BRANCH=${{ github.event.workflow_run.pull_requests[0].base.ref }}" >> $GITHUB_ENV
          else
            # For direct PR events
            echo "BASE_BRANCH=${{ github.base_ref }}" >> $GITHUB_ENV
          fi
      
      - name: Get changed files
        run: |
          git fetch origin $BASE_BRANCH --deepen=100
          git diff --name-only origin/$BASE_BRANCH...HEAD > changed_files.txt
          grep -E '\.(py|yml|yaml|json|csv)$' changed_files.txt > filtered_files.txt || true
          echo "Files to validate:"
          cat filtered_files.txt
      
      - name: Final pre-commit validation
        run: |
          if [ -s filtered_files.txt ]; then
            echo "🔍 Running final pre-commit validation..."
            if xargs pre-commit run --files < filtered_files.txt; then
              echo "✅ All pre-commit checks passed!"
            else
              echo "❌ Pre-commit validation failed!"
              echo "Some issues could not be auto-fixed and require manual intervention."
              exit 1
            fi
          else
            echo "ℹ️  No files to validate."
          fi
